!function(){function e(e,t){return function(){e.apply(t,arguments)}}function t(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],u(t,e(r,this),e(o,this))}function n(e){var t=this;return null===this._state?void this._deferreds.push(e):void c(function(){var n=t._state?e.onFulfilled:e.onRejected;if(null===n)return void(t._state?e.resolve:e.reject)(t._value);var r;try{r=n(t._value)}catch(o){return void e.reject(o)}e.resolve(r)})}function r(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void u(e(n,t),e(r,this),e(o,this))}this._state=!0,this._value=t,i.call(this)}catch(s){o.call(this,s)}}function o(e){this._state=!1,this._value=e,i.call(this)}function i(){for(var e=0,t=this._deferreds.length;t>e;e++)n.call(this,this._deferreds[e]);this._deferreds=null}function s(e,t,n,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=r}function u(e,t,n){var r=!1;try{e(function(e){r||(r=!0,t(e))},function(e){r||(r=!0,n(e))})}catch(o){if(r)return;r=!0,n(o)}}root=window;var c=t.immediateFn||root.setImmediate||function(e){setTimeout(e,1)},a=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};t.prototype["catch"]=function(e){return this.then(null,e)},t.prototype.then=function(e,r){var o=this;return new t(function(t,i){n.call(o,new s(e,r,t,i))})},t.all=function(){var e=Array.prototype.slice.call(1===arguments.length&&a(arguments[0])?arguments[0]:arguments);return new t(function(t,n){function r(i,s){try{if(s&&("object"==typeof s||"function"==typeof s)){var u=s.then;if("function"==typeof u)return void u.call(s,function(e){r(i,e)},n)}e[i]=s,0===--o&&t(e)}catch(c){n(c)}}if(0===e.length)return t([]);for(var o=e.length,i=0;i<e.length;i++)r(i,e[i])})},t.resolve=function(e){return e&&"object"==typeof e&&e.constructor===t?e:new t(function(t){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.race=function(e){return new t(function(t,n){for(var r=0,o=e.length;o>r;r++)e[r].then(t,n)})},root.Promise=t}(),function(e,t){function n(e){return e||this.timeout||this.requestTimeout}function r(e){return e||this.delay||this.requestDelay}function o(e){return e||this.then}var i,s,u,c,a,l;a={url:"http://terminal.ingenico.com/service"},c={parse:function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(t+"="+e[t]);return encodeURI(n.join("&"))},ajax:function(e,t,n,r,o,i,s,u){var c=new XMLHttpRequest;c.open(e,t,s),("POST"===e||"PUT"===e)&&(n=n&&("string"==typeof n?n:JSON.stringify(n))),c.onreadystatechange=function(){function e(){o&&o({msg:c.statusText||"XMLHttpRequest error status "+c.status,status:c.status,response:n})}function t(){r&&r(n)}var n;if(4===c.readyState)if(c.onreadystatechange=null,200===c.status||204===c.status){if(n=c&&c.responseText?JSON.parse(c.responseText):null,n&&n["return"])return e();u&&"function"==typeof u?u(n)?t():e():t()}else e()},i&&(c.timeout=i),c.setRequestHeader("Content-type","application/x-www-form-urlencoded"),c.send(n)},post:function(e,t,n,r,o,i){this.ajax("POST",e,t,n,r,o,!0,i)},get:function(e,t,n,r){this.ajax("GET",e,null,t,n,r,!0)},del:function(e,t,n,r,o,i){this.ajax("DELETE",e,t,n,r,o,i)},put:function(e,t,n,r,o){this.ajax("PUT",e,t,n,r,o,!0)}},s=[],u={},l=null;var f=function(t){var n,r,o,u,l,f;return t=t||{},r={},f=!1,o=t.service,u=t.namespace,l=t.formats,n={serviceName:o,connected:!1,promise:null,evtSource:null,handler:{resolve:null,reject:null,promise:null},requestDelay:t.requestDelay||i.requestDelay,requestTimeout:t.requestTimeout||i.requestTimeout,connect:function(e){return e=e||{},e.then=e.then||"both",this.doPromise(e,function(e,t,r){if(n.connected)return t({msg:"Already connected"});var i=function(t){return n.connected=!0,e(t)},s="";for(format in l)s+="format_"+(u||"")+"."+format+"="+l[format]+"&";return c.get(a.url+"/"+o+"?"+s,i,t,r)}),this},disconnect:function(e){return e=e||{},e.then=e.then||"both",this.doPromise(e,function(t,r,i){if(n.connected){var s=function(e){return n.connected=!1,t(e)};return c.del(a.url+"/"+o,{},s,r,i,e.async===!1?!1:!0)}return r({msg:"Not connected !"})}),this},call:function(e,t){return t=t||{},t.then=t.then||"resolved",this.doPromise(t,function(r,s,l){if(n.connected){var h=(u?u+".":"")+e+"Request",d=(u?u+".":"")+e+"Response",v=t.data||{};t.hide&&(f=!0,i.hide());var m=function(e){return f&&(f=!1,i.show()),r(e)},p=function(e){return f&&(f=!1,i.show()),s(e)};return c.post(a.url+"/"+o+"?request="+h+"&response="+d,v,m,p,l,t.expect)}return s({msg:"Not connected call"})}),this},doPromise:function(e,t){return i.doPromise.apply(this,[e,t])},reset:function(){return i.reset.call(this)},then:function(e,t){return i.then.call(this,e,t)},"catch":function(e){return i.then.call(this,null,e)},success:function(e){return i.then.call(this,e,null)},error:function(e){return i.then.call(this,null,e)},resolve:function(e){return i.resolve.call(this,e,n.handler)},reject:function(e){return i.reject.call(this,e,n.handler)},on:function(e,o,i){return e&&!e.match(/\./)&&"message"!==e&&(e=(u?u+".":"")+e),t=t||{},t.then=t.then||"resolved",this.doPromise(t,function(t,s){return n.evtSource?(i=i||n,r[e]={eventName:e,callback:o,context:i},n.evtSource.addEventListener(e,function(t){var n=JSON.parse(t.data);r[e].callback.call(i,n)},!1),t()):s()}),this},open:function(t){return t=t||{},t.then=t.then||"resolved",this.doPromise(t,function(t,r){return n.connected&&!n.evtSource?(n.evtSource=new e.EventSource(a.url+"/"+o+"/sse"),n.evtSource.onerror=function(e){return r(e)},n.evtSource.onopen=function(e){return t(e)},t()):r({msg:"Not connected or event already opened"})}),this},close:function(e){return e=e||{},e.then=e.then||"resolved",n.evtSource?(this.doPromise(e,function(e,t){return n.evtSource?(n.off(),n.evtSource.close(),n.evtSource=null,e()):t({msg:"Event source not exist"})}),this):this},off:function(e,t,o){function i(e){n.evtSource.removeEventListener(e,t||r[e].callback.bind(o),!1),delete r[e]}if(e&&!e.match(/\./)&&"message"!==e&&(e=(u?u+".":"")+e),!n.evtSource)return this;if(e)if("string"==typeof e)i(e);else if("object"==typeof e&&e instanceof Array)for(var s=0,c=e.length;c>s;s++){var a;a=e[s],i(a)}else for(var l in r){var a;a=r[l].eventName,a.match(e)&&i(a)}else for(var l in r){var a;a=r[l].eventName,i(a)}return this},destroy:function(){var e;this.disconnect().close({success:this.reset}),e=s.indexOf(this),s.splice(e,1)}}};i={version:"1.1.0",requestDelay:0,requestTimeout:0,handler:{resolve:null,reject:null,promise:null},setup:function(e,t){function n(e){e.requestDelay=i.requestDelay,e.requestTimeout=i.requestTimeout}var r="http://terminal.ingenico.com/setup";if(t&&"function"==typeof t){console.warn("Deprecated since 1.1.0");var o;"function"==typeof e?c.get(r,function(t){return n(t),e(t)}):"object"==typeof e&&(o=JSON.parse(JSON.stringify(e)),i.requestDelay=o.requestDelay||i.requestDelay,i.requestTimeout=o.requestTimeout||i.requestTimeout,delete o.requestDelay,delete o.requestTimeout,c.post(r,o,t))}else if(e=e||{},e.then=e.then||"both",e&&e.data){var s=JSON.parse(JSON.stringify(e.data));i.requestDelay=e.data.requestDelay||i.requestDelay,i.requestTimeout=e.data.requestTimeout||i.requestTimeout,delete s.requestDelay,delete s.requestTimeout,this.doPromise(e,function(e,t,n){return c.post(r,s,e,t,n)})}else this.doPromise(e,function(e,t,n){return c.get(r,e,t,n)});return this},service:function(e){var t;return e.service?(t=new f(e),s.push(t),t):new Error(".service property is missing")},disconnect:function(){for(var e=0,t=s.length;t>e;e++){var n;n=s[e],n.connected&&c.del(a.url+"/"+n.serviceName,{},function(){},function(){},n.requestTimeout,!1)}return this},destroy:function(){for(var e=0,t=s.length;t>e;e++){var n;n=s[e],n.destroy()}return this},lookup:function(e,t){if(t&&"function"==typeof t)console.warn("Deprecated since 1.1.0"),e&&c.get(a.url+"?interface="+e,t);else{var n=t||{};n.then=n.then||"both",this.doPromise(n,function(t,n,r){return c.get(a.url+"?interface="+e,t,n,r)})}return this},hide:function(){console.log("INGENICO:WCE:hide")},show:function(){console.log("INGENICO:WCE:show")},weblet:{hide:function(){return console.log("INGENICO:WEBLET:hide"),this},show:function(){return console.log("INGENICO:WEBLET:show"),this},on:function(t,n,r){return r=r||this,u[t]={eventName:t,callback:n,context:r},e.addEventListener(t,n.bind(r),!1),this},trigger:function(t,n){function r(t){var r;r=new CustomEvent(t,n),e.dispatchEvent(r)}if(n=n||{},t)if("string"==typeof t)r(t);else if("object"==typeof t&&t instanceof Array)for(var o=0,i=t.length;i>o;o++)r(t[o]);else for(var s in u){var c;c=u[s].eventName,c.match(t)&&r(c)}else for(var s in u){var c;c=u[s].eventName,r(c)}return this},off:function(t,n,r){function o(t){e.removeEventListener(t,n||u[t].callback,r||u[t].context),delete u[t]}if(t)if("string"==typeof t)o(t);else if("object"==typeof t&&t instanceof Array)for(var i=0,s=t.length;s>i;i++)o(t[i]);else for(var c in u){var a;a=u[c].eventName,a.match(t)&&o(a)}else for(var c in u){var a;a=u[c].eventName,o(a)}return this}},doPromise:function(t,i){function s(){var o;return o=new e.Promise(function(s,c){e.setTimeout(function(){return i(function(e){u.handler.resolve=s,u.handler.reject=c,u.handler.promise=o,u.resolve(e,u.handler)},function(e){u.handler.resolve=s,u.handler.reject=c,u.handler.promise=o,u.reject(e,u.handler)},n.call(u,t.requestTimeout))},r.call(u,t.requestDelay))})}var u=this;if(!this.promise||t.promise)this.promise=s();else{var c=o.call(u,t.then);"resolved"===c?u.success(s):"rejected"===c?u.error(s):u.then(s,s)}return(t.error||t.success)&&u.then(t.success,t.error),this},then:function(e,t){var n=this;return n.promise=e&&!t?n.promise.then(function(t){return e.call(n,t,n.handler)}):e&&t?n.promise.then(function(t){return e.call(n,t,n.handler)},function(e){return t.call(n,e,n.handler)}):n.promise["catch"](function(e){return t.call(n,e,n.handler)}),this},"catch":function(e){return this.then(null,e),this},success:function(e){return this.then(e,null),this},error:function(e){return this.then(null,e),this},resolve:function(e){return this.handler.resolve.call(this,e,this.handler),this},reject:function(e){return this.handler.reject.call(this,e,this.handler),this},reset:function(){return this.promise=null,this}},t.addEventListener("visibilitychange",function(){i.weblet.trigger(t.hidden?"hide":"show")}),e.addEventListener("beforeunload",function(e){e.preventDefault(),i.weblet.trigger("close"),i.disconnect()}),i.service({service:"local.desktopenv.inactivityHandler",namespace:"ingenico.desktopenv"}).connect().open().on("WakeupEvent",function(e){i.weblet.trigger("wakeup",e.cause)}),"undefined"!=typeof module&&module.exports?module.exports=i:"function"==typeof e.define&&e.define.amd?e.define("tetra",[],function(){return i}):e.tetra=i}(window,document);